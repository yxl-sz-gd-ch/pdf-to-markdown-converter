# 20250729修改日志

## 问题描述

用户报告PDF转Markdown程序中的`def run`方法存在问题，可能是缩进引起的语法错误。程序可以运行，但存在图片链接问题：

- 备用引擎PyMuPDF能够识别并提取PDF中的图片
- 图片成功保存到"原文件夹_images"文件夹中
- 但MD文档中没有正确的图片相对链接
- 显示类似`![](_page_1_Picture_2.jpeg)`这种错误的图片引用

## 用户日志信息

```
设置已加载。
已添加 1 个新文件到列表。
设置已保存。
==================================================
开始新的转换任务...
文件总数: 1
输出目录: D:/pdftomd/big
基础配置: {'output_format': 'markdown', 'format_lines': True}
使用 LLM: 是
LLM 服务: OpenAI
LLM 配置: {'llm_service': 'marker.services.openai.OpenAIService', 'openai_base_url': 'http://127.0.0.1:1234', 'model': 'phi-3.1-mini-4k-instruct'}
启用备用图片提取: 是
------------------------------
开始转换 1 个 PDF 文件...
已设置 HF_HOME 环境变量指向: D:\pdftomd
Marker 模型将从 'D:\pdftomd\markermodels' 加载/下载。
正在加载 Marker 模型...
Marker 模型加载完成。
[1/1] 正在转换: 【重要】用上了 Claude Code，才发现 Cursor 和 Gemini Cli 都是弱智。。（保姆级安装和使用教程分享）.pdf
  -> [主引擎] Marker 未提取到图片，启动备用引擎 PyMuPDF...
  -> [备用引擎] PyMuPDF 成功提取并保存了 20 张图片。
  -> 已保存: 【重要】用上了 Claude Code，才发现 Cursor 和 Gemini Cli 都是弱智。。（保姆级安装和使用教程分享）.md
🎉 转换完成! 成功: 1/1
```

## 问题分析与修复

### 1. 语法错误修复

#### 问题1：变量名错误
在`_extract_images_with_pymupdf`方法中，第87行使用了未定义的变量`page_document`：

```python
# 错误的代码
for page_index in range(len(pdf_document)):
    image_list = page_document.get_images(full=True)  # page_document未定义
```

**修复**：
```python
# 修复后的代码
for page_index in range(len(pdf_document)):
    page_document = pdf_document[page_index]  # 添加变量定义
    image_list = page_document.get_images(full=True)
```

#### 问题2：缩进错误
在`start_conversion`方法中，第623行的`if use_llm:`语句后面只有注释，没有实际的代码块：

```python
# 错误的代码
if use_llm:
    # ... (LLM 日志) ...  # 这不是有效的代码块
else:
    self.log("使用 LLM: 否")
```

**修复**：
```python
# 修复后的代码
if use_llm:
    self.log(f"使用 LLM: 是")
    self.log(f"LLM 服务: {self.llm_service_combo.currentText()}")
    # 出于安全考虑，不记录 API 密钥
    safe_llm_config = {k:v for k,v in llm_service_config.items() if 'key' not in k.lower() and 'secret' not in k.lower()}
    self.log(f"LLM 配置: {safe_llm_config}")
else:
    self.log("使用 LLM: 否")
```

#### 问题3：重复代码
删除了重复的日志记录代码块，保持代码整洁。

### 2. 图片链接问题修复

#### 核心问题
当使用备用引擎PyMuPDF提取图片时，虽然图片被保存了，但Markdown文件中的图片链接没有被正确更新，导致显示错误的图片引用。

#### 解决方案

**1. 修改`_extract_images_with_pymupdf`方法**
- 将返回值从图片数量改为图片文件名列表
- 这样可以知道具体提取了哪些图片文件

```python
# 修改前
return extracted_count  # 返回数量

# 修改后  
return extracted_files  # 返回文件名列表
```

**2. 新增`_update_markdown_image_links`方法**
这个方法实现了智能的图片链接更新功能：

```python
def _update_markdown_image_links(self, markdown_content, fallback_image_files, pdf_stem):
    """更新Markdown中的图片链接，将备用引擎提取的图片链接到正确的路径。"""
    import re
    
    if not fallback_image_files:
        return markdown_content
    
    # 查找所有的图片引用模式
    image_pattern = r'!\[([^\]]*)\]\(([^)]+)\)'
    
    def replace_image_link(match):
        alt_text = match.group(1)
        original_link = match.group(2)
        
        # 智能匹配逻辑
        # 1. 检查是否已经是相对/绝对路径
        # 2. 尝试匹配对应的备用图片
        # 3. 根据页面信息匹配
        # 4. 构建正确的相对路径
        
        if best_match:
            relative_path = f"{pdf_stem}_images/{best_match}"
            return f'![{alt_text}]({relative_path})'
        else:
            return match.group(0)
    
    # 替换所有图片链接
    updated_content = re.sub(image_pattern, replace_image_link, markdown_content)
    
    # 兜底策略：如果没有找到图片引用，在文档末尾添加图片
    if updated_content == markdown_content and fallback_image_files:
        updated_content += "\n\n## 提取的图片\n\n"
        for i, img_file in enumerate(fallback_image_files, 1):
            relative_path = f"{pdf_stem}_images/{img_file}"
            updated_content += f"![图片 {i}]({relative_path})\n\n"
    
    return updated_content
```

**3. 修改run方法的处理流程**
重新组织了图片处理的顺序：

```python
# 修改后的流程
# 步骤 2: 提取和保存图片
marker_extracted_images = False
pdf_stem = Path(pdf_path).stem
images_dir = os.path.join(self.output_dir, f"{pdf_stem}_images")
fallback_image_files = []

# 策略一: Marker主引擎提取
if hasattr(rendered, 'metadata') and hasattr(rendered.metadata, 'images'):
    # ... Marker提取逻辑

# 策略二: PyMuPDF备用引擎提取
if not marker_extracted_images:
    if self.use_fallback_extraction:
        fallback_image_files = self._extract_images_with_pymupdf(pdf_path, images_dir)

# 步骤 3: 处理Markdown内容并保存文件
markdown_content = rendered.markdown

# 如果使用了备用引擎提取图片，需要更新Markdown中的图片链接
if fallback_image_files:
    markdown_content = self._update_markdown_image_links(markdown_content, fallback_image_files, pdf_stem)

# 保存更新后的Markdown文件
md_filename = Path(pdf_path).stem + ".md"
md_output_path = os.path.join(self.output_dir, md_filename)
with open(md_output_path, 'w', encoding='utf-8') as f:
    f.write(markdown_content)
```

## 修复后的功能特性

### 1. 语法修复
- ✅ 修复了PyMuPDF图片提取方法中的变量名错误
- ✅ 修复了缩进导致的语法错误
- ✅ 清理了重复的代码
- ✅ 程序可以正常运行

### 2. 图片链接修复
- ✅ **智能匹配**：根据原始图片引用智能匹配备用引擎提取的图片
- ✅ **路径修正**：将图片链接更新为正确的相对路径格式
- ✅ **页面匹配**：尝试根据页面信息匹配对应的图片
- ✅ **兜底策略**：如果Markdown中没有图片引用，会在文档末尾添加所有提取的图片

### 3. 完整的工作流程
1. **PDF转换**：Marker将PDF转换为Markdown
2. **主引擎图片提取**：尝试使用Marker提取图片
3. **备用引擎图片提取**：如果主引擎没有提取到图片，使用PyMuPDF提取
4. **链接更新**：如果使用了备用引擎，更新Markdown中的图片链接
5. **文件保存**：保存包含正确图片链接的Markdown文件

## 预期效果

修复后，程序应该能够：
- 正确提取PDF中的图片（使用双引擎策略）
- 将图片保存到对应的文件夹中
- 在Markdown文件中生成正确的图片链接，格式类似：
  ```markdown
  ![图片描述](文件名_images/_page_1_fallback_img_1.jpeg)
  ```
- 在Markdown查看器中正常显示图片

## 技术要点

### 正则表达式匹配
使用正则表达式`r'!\[([^\]]*)\]\(([^)]+)\)'`来匹配Markdown中的图片引用格式。

### 智能路径处理
- 检查原始链接是否已经包含路径分隔符
- 根据页面信息进行智能匹配
- 构建正确的相对路径格式

### 错误处理
- 完整的异常处理机制
- 详细的日志记录
- 兜底策略确保用户能看到提取的图片

## 总结

本次修复解决了两个主要问题：
1. **语法错误**：修复了变量名错误、缩进错误和重复代码
2. **图片链接问题**：实现了智能的图片链接更新机制，确保备用引擎提取的图片能在Markdown中正确显示

修复后的程序具备了完整的双引擎图片提取功能，并能智能处理图片链接，为用户提供更好的PDF转Markdown体验。