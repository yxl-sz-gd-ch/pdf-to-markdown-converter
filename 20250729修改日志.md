# 20250729ä¿®æ”¹æ—¥å¿—

## é—®é¢˜æè¿°

ç”¨æˆ·æŠ¥å‘ŠPDFè½¬Markdownç¨‹åºä¸­çš„`def run`æ–¹æ³•å­˜åœ¨é—®é¢˜ï¼Œå¯èƒ½æ˜¯ç¼©è¿›å¼•èµ·çš„è¯­æ³•é”™è¯¯ã€‚ç¨‹åºå¯ä»¥è¿è¡Œï¼Œä½†å­˜åœ¨å›¾ç‰‡é“¾æ¥é—®é¢˜ï¼š

- å¤‡ç”¨å¼•æ“PyMuPDFèƒ½å¤Ÿè¯†åˆ«å¹¶æå–PDFä¸­çš„å›¾ç‰‡
- å›¾ç‰‡æˆåŠŸä¿å­˜åˆ°"åŸæ–‡ä»¶å¤¹_images"æ–‡ä»¶å¤¹ä¸­
- ä½†MDæ–‡æ¡£ä¸­æ²¡æœ‰æ­£ç¡®çš„å›¾ç‰‡ç›¸å¯¹é“¾æ¥
- æ˜¾ç¤ºç±»ä¼¼`![](_page_1_Picture_2.jpeg)`è¿™ç§é”™è¯¯çš„å›¾ç‰‡å¼•ç”¨

## ç”¨æˆ·æ—¥å¿—ä¿¡æ¯

```
è®¾ç½®å·²åŠ è½½ã€‚
å·²æ·»åŠ  1 ä¸ªæ–°æ–‡ä»¶åˆ°åˆ—è¡¨ã€‚
è®¾ç½®å·²ä¿å­˜ã€‚
==================================================
å¼€å§‹æ–°çš„è½¬æ¢ä»»åŠ¡...
æ–‡ä»¶æ€»æ•°: 1
è¾“å‡ºç›®å½•: D:/pdftomd/big
åŸºç¡€é…ç½®: {'output_format': 'markdown', 'format_lines': True}
ä½¿ç”¨ LLM: æ˜¯
LLM æœåŠ¡: OpenAI
LLM é…ç½®: {'llm_service': 'marker.services.openai.OpenAIService', 'openai_base_url': 'http://127.0.0.1:1234', 'model': 'phi-3.1-mini-4k-instruct'}
å¯ç”¨å¤‡ç”¨å›¾ç‰‡æå–: æ˜¯
------------------------------
å¼€å§‹è½¬æ¢ 1 ä¸ª PDF æ–‡ä»¶...
å·²è®¾ç½® HF_HOME ç¯å¢ƒå˜é‡æŒ‡å‘: D:\pdftomd
Marker æ¨¡å‹å°†ä» 'D:\pdftomd\markermodels' åŠ è½½/ä¸‹è½½ã€‚
æ­£åœ¨åŠ è½½ Marker æ¨¡å‹...
Marker æ¨¡å‹åŠ è½½å®Œæˆã€‚
[1/1] æ­£åœ¨è½¬æ¢: ã€é‡è¦ã€‘ç”¨ä¸Šäº† Claude Codeï¼Œæ‰å‘ç° Cursor å’Œ Gemini Cli éƒ½æ˜¯å¼±æ™ºã€‚ã€‚ï¼ˆä¿å§†çº§å®‰è£…å’Œä½¿ç”¨æ•™ç¨‹åˆ†äº«ï¼‰.pdf
  -> [ä¸»å¼•æ“] Marker æœªæå–åˆ°å›¾ç‰‡ï¼Œå¯åŠ¨å¤‡ç”¨å¼•æ“ PyMuPDF...
  -> [å¤‡ç”¨å¼•æ“] PyMuPDF æˆåŠŸæå–å¹¶ä¿å­˜äº† 20 å¼ å›¾ç‰‡ã€‚
  -> å·²ä¿å­˜: ã€é‡è¦ã€‘ç”¨ä¸Šäº† Claude Codeï¼Œæ‰å‘ç° Cursor å’Œ Gemini Cli éƒ½æ˜¯å¼±æ™ºã€‚ã€‚ï¼ˆä¿å§†çº§å®‰è£…å’Œä½¿ç”¨æ•™ç¨‹åˆ†äº«ï¼‰.md
ğŸ‰ è½¬æ¢å®Œæˆ! æˆåŠŸ: 1/1
```

## é—®é¢˜åˆ†æä¸ä¿®å¤

### 1. è¯­æ³•é”™è¯¯ä¿®å¤

#### é—®é¢˜1ï¼šå˜é‡åé”™è¯¯
åœ¨`_extract_images_with_pymupdf`æ–¹æ³•ä¸­ï¼Œç¬¬87è¡Œä½¿ç”¨äº†æœªå®šä¹‰çš„å˜é‡`page_document`ï¼š

```python
# é”™è¯¯çš„ä»£ç 
for page_index in range(len(pdf_document)):
    image_list = page_document.get_images(full=True)  # page_documentæœªå®šä¹‰
```

**ä¿®å¤**ï¼š
```python
# ä¿®å¤åçš„ä»£ç 
for page_index in range(len(pdf_document)):
    page_document = pdf_document[page_index]  # æ·»åŠ å˜é‡å®šä¹‰
    image_list = page_document.get_images(full=True)
```

#### é—®é¢˜2ï¼šç¼©è¿›é”™è¯¯
åœ¨`start_conversion`æ–¹æ³•ä¸­ï¼Œç¬¬623è¡Œçš„`if use_llm:`è¯­å¥åé¢åªæœ‰æ³¨é‡Šï¼Œæ²¡æœ‰å®é™…çš„ä»£ç å—ï¼š

```python
# é”™è¯¯çš„ä»£ç 
if use_llm:
    # ... (LLM æ—¥å¿—) ...  # è¿™ä¸æ˜¯æœ‰æ•ˆçš„ä»£ç å—
else:
    self.log("ä½¿ç”¨ LLM: å¦")
```

**ä¿®å¤**ï¼š
```python
# ä¿®å¤åçš„ä»£ç 
if use_llm:
    self.log(f"ä½¿ç”¨ LLM: æ˜¯")
    self.log(f"LLM æœåŠ¡: {self.llm_service_combo.currentText()}")
    # å‡ºäºå®‰å…¨è€ƒè™‘ï¼Œä¸è®°å½• API å¯†é’¥
    safe_llm_config = {k:v for k,v in llm_service_config.items() if 'key' not in k.lower() and 'secret' not in k.lower()}
    self.log(f"LLM é…ç½®: {safe_llm_config}")
else:
    self.log("ä½¿ç”¨ LLM: å¦")
```

#### é—®é¢˜3ï¼šé‡å¤ä»£ç 
åˆ é™¤äº†é‡å¤çš„æ—¥å¿—è®°å½•ä»£ç å—ï¼Œä¿æŒä»£ç æ•´æ´ã€‚

### 2. å›¾ç‰‡é“¾æ¥é—®é¢˜ä¿®å¤

#### æ ¸å¿ƒé—®é¢˜
å½“ä½¿ç”¨å¤‡ç”¨å¼•æ“PyMuPDFæå–å›¾ç‰‡æ—¶ï¼Œè™½ç„¶å›¾ç‰‡è¢«ä¿å­˜äº†ï¼Œä½†Markdownæ–‡ä»¶ä¸­çš„å›¾ç‰‡é“¾æ¥æ²¡æœ‰è¢«æ­£ç¡®æ›´æ–°ï¼Œå¯¼è‡´æ˜¾ç¤ºé”™è¯¯çš„å›¾ç‰‡å¼•ç”¨ã€‚

#### è§£å†³æ–¹æ¡ˆ

**1. ä¿®æ”¹`_extract_images_with_pymupdf`æ–¹æ³•**
- å°†è¿”å›å€¼ä»å›¾ç‰‡æ•°é‡æ”¹ä¸ºå›¾ç‰‡æ–‡ä»¶ååˆ—è¡¨
- è¿™æ ·å¯ä»¥çŸ¥é“å…·ä½“æå–äº†å“ªäº›å›¾ç‰‡æ–‡ä»¶

```python
# ä¿®æ”¹å‰
return extracted_count  # è¿”å›æ•°é‡

# ä¿®æ”¹å  
return extracted_files  # è¿”å›æ–‡ä»¶ååˆ—è¡¨
```

**2. æ–°å¢`_update_markdown_image_links`æ–¹æ³•**
è¿™ä¸ªæ–¹æ³•å®ç°äº†æ™ºèƒ½çš„å›¾ç‰‡é“¾æ¥æ›´æ–°åŠŸèƒ½ï¼š

```python
def _update_markdown_image_links(self, markdown_content, fallback_image_files, pdf_stem):
    """æ›´æ–°Markdownä¸­çš„å›¾ç‰‡é“¾æ¥ï¼Œå°†å¤‡ç”¨å¼•æ“æå–çš„å›¾ç‰‡é“¾æ¥åˆ°æ­£ç¡®çš„è·¯å¾„ã€‚"""
    import re
    
    if not fallback_image_files:
        return markdown_content
    
    # æŸ¥æ‰¾æ‰€æœ‰çš„å›¾ç‰‡å¼•ç”¨æ¨¡å¼
    image_pattern = r'!\[([^\]]*)\]\(([^)]+)\)'
    
    def replace_image_link(match):
        alt_text = match.group(1)
        original_link = match.group(2)
        
        # æ™ºèƒ½åŒ¹é…é€»è¾‘
        # 1. æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯ç›¸å¯¹/ç»å¯¹è·¯å¾„
        # 2. å°è¯•åŒ¹é…å¯¹åº”çš„å¤‡ç”¨å›¾ç‰‡
        # 3. æ ¹æ®é¡µé¢ä¿¡æ¯åŒ¹é…
        # 4. æ„å»ºæ­£ç¡®çš„ç›¸å¯¹è·¯å¾„
        
        if best_match:
            relative_path = f"{pdf_stem}_images/{best_match}"
            return f'![{alt_text}]({relative_path})'
        else:
            return match.group(0)
    
    # æ›¿æ¢æ‰€æœ‰å›¾ç‰‡é“¾æ¥
    updated_content = re.sub(image_pattern, replace_image_link, markdown_content)
    
    # å…œåº•ç­–ç•¥ï¼šå¦‚æœæ²¡æœ‰æ‰¾åˆ°å›¾ç‰‡å¼•ç”¨ï¼Œåœ¨æ–‡æ¡£æœ«å°¾æ·»åŠ å›¾ç‰‡
    if updated_content == markdown_content and fallback_image_files:
        updated_content += "\n\n## æå–çš„å›¾ç‰‡\n\n"
        for i, img_file in enumerate(fallback_image_files, 1):
            relative_path = f"{pdf_stem}_images/{img_file}"
            updated_content += f"![å›¾ç‰‡ {i}]({relative_path})\n\n"
    
    return updated_content
```

**3. ä¿®æ”¹runæ–¹æ³•çš„å¤„ç†æµç¨‹**
é‡æ–°ç»„ç»‡äº†å›¾ç‰‡å¤„ç†çš„é¡ºåºï¼š

```python
# ä¿®æ”¹åçš„æµç¨‹
# æ­¥éª¤ 2: æå–å’Œä¿å­˜å›¾ç‰‡
marker_extracted_images = False
pdf_stem = Path(pdf_path).stem
images_dir = os.path.join(self.output_dir, f"{pdf_stem}_images")
fallback_image_files = []

# ç­–ç•¥ä¸€: Markerä¸»å¼•æ“æå–
if hasattr(rendered, 'metadata') and hasattr(rendered.metadata, 'images'):
    # ... Markeræå–é€»è¾‘

# ç­–ç•¥äºŒ: PyMuPDFå¤‡ç”¨å¼•æ“æå–
if not marker_extracted_images:
    if self.use_fallback_extraction:
        fallback_image_files = self._extract_images_with_pymupdf(pdf_path, images_dir)

# æ­¥éª¤ 3: å¤„ç†Markdownå†…å®¹å¹¶ä¿å­˜æ–‡ä»¶
markdown_content = rendered.markdown

# å¦‚æœä½¿ç”¨äº†å¤‡ç”¨å¼•æ“æå–å›¾ç‰‡ï¼Œéœ€è¦æ›´æ–°Markdownä¸­çš„å›¾ç‰‡é“¾æ¥
if fallback_image_files:
    markdown_content = self._update_markdown_image_links(markdown_content, fallback_image_files, pdf_stem)

# ä¿å­˜æ›´æ–°åçš„Markdownæ–‡ä»¶
md_filename = Path(pdf_path).stem + ".md"
md_output_path = os.path.join(self.output_dir, md_filename)
with open(md_output_path, 'w', encoding='utf-8') as f:
    f.write(markdown_content)
```

## ä¿®å¤åçš„åŠŸèƒ½ç‰¹æ€§

### 1. è¯­æ³•ä¿®å¤
- âœ… ä¿®å¤äº†PyMuPDFå›¾ç‰‡æå–æ–¹æ³•ä¸­çš„å˜é‡åé”™è¯¯
- âœ… ä¿®å¤äº†ç¼©è¿›å¯¼è‡´çš„è¯­æ³•é”™è¯¯
- âœ… æ¸…ç†äº†é‡å¤çš„ä»£ç 
- âœ… ç¨‹åºå¯ä»¥æ­£å¸¸è¿è¡Œ

### 2. å›¾ç‰‡é“¾æ¥ä¿®å¤
- âœ… **æ™ºèƒ½åŒ¹é…**ï¼šæ ¹æ®åŸå§‹å›¾ç‰‡å¼•ç”¨æ™ºèƒ½åŒ¹é…å¤‡ç”¨å¼•æ“æå–çš„å›¾ç‰‡
- âœ… **è·¯å¾„ä¿®æ­£**ï¼šå°†å›¾ç‰‡é“¾æ¥æ›´æ–°ä¸ºæ­£ç¡®çš„ç›¸å¯¹è·¯å¾„æ ¼å¼
- âœ… **é¡µé¢åŒ¹é…**ï¼šå°è¯•æ ¹æ®é¡µé¢ä¿¡æ¯åŒ¹é…å¯¹åº”çš„å›¾ç‰‡
- âœ… **å…œåº•ç­–ç•¥**ï¼šå¦‚æœMarkdownä¸­æ²¡æœ‰å›¾ç‰‡å¼•ç”¨ï¼Œä¼šåœ¨æ–‡æ¡£æœ«å°¾æ·»åŠ æ‰€æœ‰æå–çš„å›¾ç‰‡

### 3. å®Œæ•´çš„å·¥ä½œæµç¨‹
1. **PDFè½¬æ¢**ï¼šMarkerå°†PDFè½¬æ¢ä¸ºMarkdown
2. **ä¸»å¼•æ“å›¾ç‰‡æå–**ï¼šå°è¯•ä½¿ç”¨Markeræå–å›¾ç‰‡
3. **å¤‡ç”¨å¼•æ“å›¾ç‰‡æå–**ï¼šå¦‚æœä¸»å¼•æ“æ²¡æœ‰æå–åˆ°å›¾ç‰‡ï¼Œä½¿ç”¨PyMuPDFæå–
4. **é“¾æ¥æ›´æ–°**ï¼šå¦‚æœä½¿ç”¨äº†å¤‡ç”¨å¼•æ“ï¼Œæ›´æ–°Markdownä¸­çš„å›¾ç‰‡é“¾æ¥
5. **æ–‡ä»¶ä¿å­˜**ï¼šä¿å­˜åŒ…å«æ­£ç¡®å›¾ç‰‡é“¾æ¥çš„Markdownæ–‡ä»¶

## é¢„æœŸæ•ˆæœ

ä¿®å¤åï¼Œç¨‹åºåº”è¯¥èƒ½å¤Ÿï¼š
- æ­£ç¡®æå–PDFä¸­çš„å›¾ç‰‡ï¼ˆä½¿ç”¨åŒå¼•æ“ç­–ç•¥ï¼‰
- å°†å›¾ç‰‡ä¿å­˜åˆ°å¯¹åº”çš„æ–‡ä»¶å¤¹ä¸­
- åœ¨Markdownæ–‡ä»¶ä¸­ç”Ÿæˆæ­£ç¡®çš„å›¾ç‰‡é“¾æ¥ï¼Œæ ¼å¼ç±»ä¼¼ï¼š
  ```markdown
  ![å›¾ç‰‡æè¿°](æ–‡ä»¶å_images/_page_1_fallback_img_1.jpeg)
  ```
- åœ¨MarkdownæŸ¥çœ‹å™¨ä¸­æ­£å¸¸æ˜¾ç¤ºå›¾ç‰‡

## æŠ€æœ¯è¦ç‚¹

### æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…
ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼`r'!\[([^\]]*)\]\(([^)]+)\)'`æ¥åŒ¹é…Markdownä¸­çš„å›¾ç‰‡å¼•ç”¨æ ¼å¼ã€‚

### æ™ºèƒ½è·¯å¾„å¤„ç†
- æ£€æŸ¥åŸå§‹é“¾æ¥æ˜¯å¦å·²ç»åŒ…å«è·¯å¾„åˆ†éš”ç¬¦
- æ ¹æ®é¡µé¢ä¿¡æ¯è¿›è¡Œæ™ºèƒ½åŒ¹é…
- æ„å»ºæ­£ç¡®çš„ç›¸å¯¹è·¯å¾„æ ¼å¼

### é”™è¯¯å¤„ç†
- å®Œæ•´çš„å¼‚å¸¸å¤„ç†æœºåˆ¶
- è¯¦ç»†çš„æ—¥å¿—è®°å½•
- å…œåº•ç­–ç•¥ç¡®ä¿ç”¨æˆ·èƒ½çœ‹åˆ°æå–çš„å›¾ç‰‡

## æ€»ç»“

æœ¬æ¬¡ä¿®å¤è§£å†³äº†ä¸¤ä¸ªä¸»è¦é—®é¢˜ï¼š
1. **è¯­æ³•é”™è¯¯**ï¼šä¿®å¤äº†å˜é‡åé”™è¯¯ã€ç¼©è¿›é”™è¯¯å’Œé‡å¤ä»£ç 
2. **å›¾ç‰‡é“¾æ¥é—®é¢˜**ï¼šå®ç°äº†æ™ºèƒ½çš„å›¾ç‰‡é“¾æ¥æ›´æ–°æœºåˆ¶ï¼Œç¡®ä¿å¤‡ç”¨å¼•æ“æå–çš„å›¾ç‰‡èƒ½åœ¨Markdownä¸­æ­£ç¡®æ˜¾ç¤º

ä¿®å¤åçš„ç¨‹åºå…·å¤‡äº†å®Œæ•´çš„åŒå¼•æ“å›¾ç‰‡æå–åŠŸèƒ½ï¼Œå¹¶èƒ½æ™ºèƒ½å¤„ç†å›¾ç‰‡é“¾æ¥ï¼Œä¸ºç”¨æˆ·æä¾›æ›´å¥½çš„PDFè½¬Markdownä½“éªŒã€‚