# PDF to Markdown Converter 详细教程

## 📚 目录

1. [环境准备](#环境准备)
2. [安装步骤](#安装步骤)
3. [界面介绍](#界面介绍)
4. [基础使用](#基础使用)
5. [高级配置](#高级配置)
6. [LLM 集成](#llm-集成)
7. [批量处理](#批量处理)
8. [图片处理详解](#图片处理详解)
9. [输出格式说明](#输出格式说明)
10. [性能优化](#性能优化)
11. [故障排除](#故障排除)
12. [最佳实践](#最佳实践)

## 🔧 环境准备

### 系统要求检查

在开始安装之前，请确保您的系统满足以下要求：

```bash
# 检查 Python 版本
python --version
# 应该显示 Python 3.8.x 或更高版本

# 检查 pip 版本
pip --version

# 检查可用内存（推荐 8GB 以上）
# Windows: 任务管理器 -> 性能 -> 内存
```

### 必要工具安装

1. **Python 3.8+**
   - 从 [python.org](https://www.python.org/downloads/) 下载并安装
   - 安装时勾选"Add Python to PATH"

2. **Git**（可选，用于克隆项目）
   - 从 [git-scm.com](https://git-scm.com/downloads) 下载并安装

## 📦 安装步骤

### 方法一：从 GitHub 克隆（推荐）

```bash
# 1. 克隆项目到本地
git clone https://github.com/yourusername/pdf-to-markdown-converter.git
cd pdf-to-markdown-converter

# 2. 创建虚拟环境
python -m venv env310

# 3. 激活虚拟环境
# Windows:
env310\Scripts\activate
# Linux/Mac:
# source env310/bin/activate

# 4. 升级 pip
python -m pip install --upgrade pip

# 5. 安装依赖
pip install -r requirements【必须的库包】.txt

# 6. 验证安装
python main.py
```

### 方法二：手动下载安装

1. 从 GitHub 下载项目压缩包
2. 解压到目标目录
3. 按照方法一的步骤 2-6 执行

### 安装验证

成功安装后，运行程序应该看到如下界面：

```
PDF to Markdown 批量转换器 (基于 Marker)
┌─────────────────────────────────────┐
│ 1. 选择 PDF 文件                    │
│ [选择 PDF 文件] [选择包含 PDF 的文件夹] │
│                                     │
│ 文件列表：                          │
│ (空)                                │
└─────────────────────────────────────┘
```

## 🖥 界面介绍

### 主界面布局

程序界面分为以下几个主要区域：

#### 1. 文件选择区域
- **选择 PDF 文件**：选择单个或多个 PDF 文件
- **选择包含 PDF 的文件夹**：批量添加文件夹中的所有 PDF
- **文件列表**：显示待转换的文件列表
- **移除选中**：从列表中移除选中的文件
- **清空列表**：清空整个文件列表

#### 2. 配置选项卡

##### 基础设置选项卡
- **输出目录**：设置转换结果的保存位置
- **页码范围**：指定要转换的页面（如：1,3-5,10）
- **格式化行**：改善数学公式的显示效果
- **强制 OCR**：对所有页面强制执行 OCR
- **移除现有 OCR 文本**：清除 PDF 中已有的 OCR 文本

##### LLM 设置选项卡
- **使用 LLM 提高准确性**：启用 AI 辅助转换
- **LLM 服务**：选择 AI 服务提供商
- **API 密钥**：输入对应服务的 API 密钥
- **Base URL**：自定义 API 端点（支持本地服务）
- **模型名称**：指定使用的具体模型

##### 高级设置选项卡
- **输出格式**：选择输出格式（Markdown/JSON/HTML/Chunks）
- **启用调试模式**：输出详细的调试信息
- **工作进程数**：设置并发处理的进程数量
- **启用 PyMuPDF 作为备用图片提取引擎**：双引擎图片提取

#### 3. 操作控制区域
- **🚀 开始转换**：启动转换任务
- **⏹ 停止**：中止正在进行的转换

#### 4. 进度和日志区域
- **进度条**：显示整体转换进度
- **日志窗口**：实时显示转换过程和结果
- **💾 保存日志**：将日志保存到文件
- **🗑 清空日志**：清空日志内容

## 🚀 基础使用

### 第一次使用

#### 步骤 1：准备 PDF 文件
```
示例文件结构：
Documents/
├── report1.pdf
├── manual.pdf
└── presentation.pdf
```

#### 步骤 2：启动程序
```bash
cd pdf-to-markdown-converter
env310\Scripts\activate  # 激活虚拟环境
python main.py
```

#### 步骤 3：添加文件
1. 点击"选择 PDF 文件"按钮
2. 在文件对话框中选择要转换的 PDF 文件
3. 文件将出现在文件列表中

#### 步骤 4：设置输出目录
1. 在"基础设置"选项卡中
2. 点击"浏览..."按钮选择输出目录
3. 或直接在文本框中输入路径

#### 步骤 5：开始转换
1. 点击"🚀 开始转换"按钮
2. 观察进度条和日志信息
3. 转换完成后会显示成功消息

### 转换结果示例

转换完成后，您将在输出目录中看到：

```
output/
├── report1.md                    # 转换后的 Markdown 文件
├── report1_images/               # 提取的图片文件夹
│   ├── _page_1_fallback_img_1.jpeg
│   ├── _page_2_fallback_img_1.png
│   └── ...
├── manual.md
├── manual_images/
└── ...
```

## ⚙️ 高级配置

### 页面范围控制

支持多种页面范围格式：

```
单页：1
多页：1,3,5
范围：1-5
组合：1,3-5,10,15-20
全部：留空或不填
```

### 输出格式详解

#### Markdown 格式（推荐）
- 标准的 Markdown 语法
- 包含图片链接和表格
- 适合文档编辑和发布

#### JSON 格式
```json
{
  "content": "文档内容",
  "metadata": {
    "pages": 10,
    "images": ["img1.jpg", "img2.png"]
  }
}
```

#### HTML 格式
- 完整的 HTML 文档
- 包含 CSS 样式
- 适合网页展示

#### Chunks 格式
- 将文档分割为语义块
- 适合向量数据库存储
- 便于 RAG 应用

### OCR 选项配置

#### 强制 OCR
- 适用于扫描文档
- 处理图片化的 PDF
- 提高文字识别准确性

#### 移除现有 OCR 文本
- 清除质量较差的 OCR 结果
- 重新进行文字识别
- 改善转换质量

## 🤖 LLM 集成

### 支持的 LLM 服务

#### 1. OpenAI
```
服务：OpenAI
API 密钥：sk-xxxxxxxxxxxxxxxx
Base URL：https://api.openai.com/v1
模型名称：gpt-4, gpt-3.5-turbo
```

#### 2. 本地 LM Studio
```
服务：OpenAI
API 密钥：lm-studio（任意值）
Base URL：http://127.0.0.1:1234
模型名称：加载的模型名称
```

#### 3. Ollama
```
服务：Ollama
Base URL：http://localhost:11434
模型名称：llama3, mistral, codellama
```

#### 4. Claude
```
服务：Claude
API 密钥：sk-ant-xxxxxxxxxxxxxxxx
模型名称：claude-3-sonnet, claude-3-haiku
```

#### 5. Gemini
```
服务：Gemini
API 密钥：AIzaxxxxxxxxxxxxxxxx
模型名称：gemini-pro, gemini-flash
```

### LLM 配置示例

#### 配置 LM Studio（本地 LLM）
1. 下载并安装 LM Studio
2. 加载一个模型（如 Phi-3.1-mini）
3. 启动本地服务器
4. 在程序中配置：
   - 服务：OpenAI
   - Base URL：http://127.0.0.1:1234
   - 模型：phi-3.1-mini-4k-instruct

#### 配置 OpenAI
1. 获取 OpenAI API 密钥
2. 在程序中配置：
   - 服务：OpenAI
   - API 密钥：您的密钥
   - 模型：gpt-4

### LLM 使用效果

启用 LLM 后，转换质量将显著提升：
- 更准确的表格识别
- 更好的公式处理
- 改善的文档结构理解
- 更智能的图片描述

## 📁 批量处理

### 批量处理策略

#### 方法 1：文件夹批量处理
1. 点击"选择包含 PDF 的文件夹"
2. 选择包含多个 PDF 的文件夹
3. 程序会自动添加所有 PDF 文件

#### 方法 2：多文件选择
1. 点击"选择 PDF 文件"
2. 在文件对话框中按住 Ctrl 键选择多个文件
3. 点击"打开"添加所有选中文件

### 批量处理优化

#### 性能建议
- 建议每批处理 10-20 个文件
- 大文件建议单独处理
- 监控系统内存使用情况

#### 错误处理
- 单个文件失败不会影响其他文件
- 详细的错误日志帮助定位问题
- 支持中途停止和恢复

## 🖼 图片处理详解

### 双引擎架构

#### 主引擎：Marker
- **优势**：智能识别文档结构，准确定位图片位置
- **适用**：结构化文档，学术论文，技术手册
- **输出**：高质量的图片和精确的位置信息

#### 备用引擎：PyMuPDF
- **优势**：全量提取，不遗漏任何图片
- **适用**：复杂排版，扫描文档，图片密集型文档
- **输出**：完整的图片集合

### 图片处理流程

```
PDF 文档
    ↓
主引擎 Marker 分析
    ↓
是否提取到图片？
    ├─ 是 → 保存图片，生成 Markdown
    └─ 否 → 启动备用引擎 PyMuPDF
              ↓
          全量提取图片
              ↓
          智能匹配和插入
              ↓
          更新 Markdown 链接
```

### 图片智能插入策略

#### 策略 1：页面相关内容匹配
```markdown
# 第3页内容
这里是第3页的文字内容...

![第3页图片](document_images/_page_3_fallback_img_1.jpeg)

继续第3页的内容...
```

#### 策略 2：标题层级插入
```markdown
## 章节标题
文字内容...

![相关图片](document_images/_page_5_fallback_img_2.png)

## 下一章节
```

#### 策略 3：文档末尾补充
```markdown
## 补充图片

*以下是PDF中提取到但未在原文档中引用的图片：*

![第1页图片](document_images/_page_1_fallback_img_1.jpeg)

![第2页图片](document_images/_page_2_fallback_img_1.png)
```

### 图片文件命名规则

```
格式：_page_{页码}_fallback_img_{序号}.{扩展名}

示例：
_page_1_fallback_img_1.jpeg  # 第1页第1张图片
_page_1_fallback_img_2.png   # 第1页第2张图片
_page_2_fallback_img_1.gif   # 第2页第1张图片
```

## 📄 输出格式说明

### Markdown 格式特性

#### 标准元素支持
```markdown
# 标题层级
## 二级标题
### 三级标题

**粗体文本**
*斜体文本*

- 无序列表
1. 有序列表

| 表格 | 支持 |
|------|------|
| 数据 | 完整 |

![图片](path/to/image.jpg)

[链接](https://example.com)
```

#### 数学公式支持
```markdown
行内公式：$E = mc^2$

块级公式：
$$
\int_{-\infty}^{\infty} e^{-x^2} dx = \sqrt{\pi}
$$
```

#### 代码块支持
```markdown
行内代码：`print("Hello World")`

代码块：
```python
def hello():
    print("Hello World")
```
```

### JSON 格式结构

```json
{
  "markdown": "完整的 Markdown 内容",
  "metadata": {
    "pages": 10,
    "title": "文档标题",
    "author": "作者信息",
    "creation_date": "2024-01-01",
    "images": {
      "image1.jpg": "base64编码的图片数据",
      "image2.png": "base64编码的图片数据"
    }
  },
  "processing_info": {
    "conversion_time": 45.2,
    "llm_used": true,
    "ocr_applied": false
  }
}
```

## 🚀 性能优化

### 系统资源优化

#### 内存管理
```python
# 推荐配置
工作进程数：2-4（根据CPU核心数）
内存要求：8GB+（处理大文件时）
存储空间：5GB+（模型缓存）
```

#### 处理策略
- **小文件（<10MB）**：可批量处理
- **中等文件（10-50MB）**：建议分批处理
- **大文件（>50MB）**：单独处理，关闭其他程序

### 模型缓存优化

#### 自定义模型目录
程序会自动设置模型缓存目录：
```
项目根目录/
├── markermodels/          # 模型缓存目录
│   ├── layout/
│   ├── ocr_error_detection/
│   ├── table_recognition/
│   ├── text_detection/
│   └── text_recognition/
└── main.py
```

#### 首次运行优化
- 首次运行会下载模型（约2-3GB）
- 建议在网络良好时进行首次运行
- 后续运行将使用本地缓存，速度更快

### 转换速度优化

#### 影响因素
1. **文档复杂度**：图片多、表格复杂的文档处理时间更长
2. **LLM 使用**：启用 LLM 会增加处理时间但提高质量
3. **OCR 处理**：强制 OCR 会显著增加处理时间
4. **系统性能**：CPU、内存、存储速度都会影响性能

#### 优化建议
```
快速模式（质量一般）：
- 关闭 LLM
- 关闭强制 OCR
- 使用默认设置

平衡模式（推荐）：
- 启用 LLM
- 启用备用图片提取
- 适当的工作进程数

高质量模式（速度较慢）：
- 启用所有功能
- 使用高质量 LLM 模型
- 强制 OCR 处理
```

## 🔧 故障排除

### 常见错误及解决方案

#### 1. 依赖安装问题

**错误信息**：
```
ModuleNotFoundError: No module named 'marker'
```

**解决方案**：
```bash
# 重新安装依赖
pip install -r requirements【必须的库包】.txt

# 如果仍有问题，尝试清理缓存
pip cache purge
pip install --no-cache-dir -r requirements【必须的库包】.txt
```

#### 2. 内存不足错误

**错误信息**：
```
RuntimeError: CUDA out of memory
MemoryError: Unable to allocate array
```

**解决方案**：
```python
# 减少工作进程数
工作进程数：1-2

# 关闭其他占用内存的程序
# 处理较小的文件
# 考虑升级系统内存
```

#### 3. 模型下载失败

**错误信息**：
```
ConnectionError: Failed to download model
```

**解决方案**：
```bash
# 检查网络连接
ping huggingface.co

# 设置代理（如果需要）
export HTTP_PROXY=http://proxy:port
export HTTPS_PROXY=http://proxy:port

# 手动下载模型到 markermodels 目录
```

#### 4. LLM 服务连接失败

**错误信息**：
```
OpenAI API Error: Invalid API key
Connection refused: Unable to connect to service
```

**解决方案**：
```python
# 检查 API 密钥
# 验证 Base URL 配置
# 确认服务状态

# 本地服务检查
curl http://127.0.0.1:1234/v1/models
```

#### 5. 图片提取失败

**错误信息**：
```
PyMuPDF not available
Image extraction failed
```

**解决方案**：
```bash
# 安装 PyMuPDF
pip install PyMuPDF

# 检查 PDF 文件完整性
# 尝试使用其他 PDF 文件测试
```

### 日志分析指南

#### 正常转换日志
```
==================================================
开始新的转换任务...
文件总数: 1
输出目录: D:/output
基础配置: {'output_format': 'markdown'}
使用 LLM: 是
启用备用图片提取: 是
------------------------------
开始转换 1 个 PDF 文件...
已设置 HF_HOME 环境变量指向: D:\project
Marker 模型将从 'D:\project\markermodels' 加载/下载。
正在加载 Marker 模型...
Marker 模型加载完成。
[1/1] 正在转换: document.pdf
  -> [主引擎] Marker 未提取到图片，启动备用引擎 PyMuPDF...
  -> [备用引擎] PyMuPDF 成功提取并保存了 5 张图片。
  -> 发现 3 张未在原Markdown中引用的图片，将添加到文档中
  -> 在文档末尾添加剩余的 2 张图片
  -> 已保存: document.md
🎉 转换完成! 成功: 1/1
```

#### 错误日志分析
```
严重错误: 加载 Marker 模型失败: No module named 'torch'
  -> 解决：安装 PyTorch

转换失败 'document.pdf': [Errno 2] No such file or directory
  -> 解决：检查文件路径

[备用引擎] PyMuPDF 提取图片时发生错误: Document is encrypted
  -> 解决：PDF 文件已加密，需要先解密
```

## 💡 最佳实践

### 文档类型优化策略

#### 学术论文
```python
推荐配置：
- 启用 LLM（提高公式和表格识别）
- 启用备用图片提取
- 输出格式：Markdown
- 格式化行：启用
```

#### 技术手册
```python
推荐配置：
- 启用 LLM
- 启用备用图片提取
- 页面范围：按章节分批处理
- 输出格式：Markdown 或 HTML
```

#### 扫描文档
```python
推荐配置：
- 强制 OCR：启用
- 移除现有 OCR 文本：启用
- 启用 LLM（提高识别准确性）
- 工作进程数：1-2（OCR 占用资源较多）
```

#### 图片密集型文档
```python
推荐配置：
- 启用备用图片提取
- 输出格式：Markdown
- 单独处理（避免内存不足）
```

### 工作流程建议

#### 1. 预处理阶段
```bash
# 检查 PDF 文件
- 文件大小和页数
- 是否加密
- 图片数量估算
- 文档类型判断
```

#### 2. 配置选择
```python
# 根据文档特点选择配置
if 文档类型 == "学术论文":
    启用_LLM = True
    格式化行 = True
elif 文档类型 == "扫描文档":
    强制_OCR = True
    移除现有_OCR = True
```

#### 3. 批量处理策略
```python
# 文件分组处理
小文件组 = [f for f in files if size(f) < 10MB]
大文件组 = [f for f in files if size(f) >= 10MB]

# 分别处理
process_batch(小文件组, batch_size=10)
process_single(大文件组)
```

#### 4. 质量检查
```markdown
转换后检查清单：
□ Markdown 语法正确
□ 图片链接有效
□ 表格格式完整
□ 公式显示正常
□ 文档结构清晰
```

### 性能监控

#### 系统资源监控
```python
# 监控指标
- CPU 使用率
- 内存使用量
- 磁盘 I/O
- 网络连接（LLM 服务）
```

#### 转换质量评估
```python
# 质量指标
- 转换成功率
- 图片提取完整性
- 文本识别准确性
- 格式保持度
```

### 备份和恢复

#### 配置备份
```bash
# 导出设置
程序会自动保存设置到注册表
# 手动备份配置文件（如果需要）
```

#### 结果备份
```bash
# 建议的备份策略
output/
├── backup_2024_01_01/    # 按日期备份
│   ├── document1.md
│   └── document1_images/
└── current/              # 当前结果
    ├── document2.md
    └── document2_images/
```

---

## 🎯 总结

通过本教程，您应该能够：

1. ✅ 成功安装和配置程序
2. ✅ 理解双引擎图片提取机制
3. ✅ 掌握各种配置选项的使用
4. ✅ 集成和使用 LLM 服务
5. ✅ 进行高效的批量处理
6. ✅ 解决常见问题和错误
7. ✅ 优化转换质量和性能

如果您在使用过程中遇到问题，请参考故障排除章节或在 GitHub 上提交 Issue。

**祝您使用愉快！** 🎉